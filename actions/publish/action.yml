name: Publish snap
description: >
  Publish a snap and its components to a channel in the Snap Store.
  
  The channel is set based on the tigger:
  - Git main branch: <track>/edge
  - Other git branches: <track>/edge/<branch>
  - PR: <tracklatest/edge/pr-<pr-num>

inputs:
  store-credentials:
    description: >
      The Snapcraft store credentials to use

      This parameter is required to publish a snap and
      its components to Snap Store.
    default: ''
    required: true
  snap-track:
    description: The snap channel's track
    default: 'latest'
    required: true

runs:
  using: composite
  steps:
    # Requires store credentials secret set.
    # Check README.md for steps on how to generate it and use it in workflows.
    - name: Publish snap
      shell: bash
      env:
        SNAPCRAFT_STORE_CREDENTIALS: ${{ inputs.store-credentials }}
      run: |
        if [ -z "$SNAPCRAFT_STORE_CREDENTIALS" ]; then
          echo "SNAPCRAFT_STORE_CREDENTIALS is not set."
          exit 1
        fi

        # Construct the snap channel
        channel_track="${{ inputs.snap-track }}"
        channel_risk="edge"
        channel="$channel_track/$channel_risk

        # Triggered from a branch other than main
        # TBA: use git branch in channel branch

        # Triggered from a PR
        if [ -n "${{ github.event.number }}" ]; then
          echo "Triggered from PR: ${{ github.event.number }}"
          channel_branch="pr-${{ github.event.number }}"
          channel+="/$channel_branch"
        fi

        echo "Using channel: $channel"

        "${{ github.action_path }}/upload.sh" "$channel"
